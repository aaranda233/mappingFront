<div x-data="chatWidget()" x-init="$nextTick(() => init())" class="fixed bottom-5 right-5 z-50 select-none">
  <!-- Bot√≥n de apertura -->
  <button id="chat-toggle-button" @click="open = !open; $nextTick(() => open && $refs.input.focus())"
    :class="loading ? 'bg-gradient-to-br from-[#f15a24] to-[#ff9f40] animate-pulse shadow-[0_0_20px_rgba(241,90,36,0.5)] scale-105' : 'bg-white/90'"
    class="group relative flex items-center justify-center w-14 h-14 rounded-full backdrop-blur-md shadow-lg border border-gray-200 hover:shadow-2xl transition-all duration-300 hover:scale-105"
    title="Abrir asistente">
    <div class="absolute inset-0 rounded-full bg-[#f15a24]/10 pointer-events-none animate-pulse"></div>
    <template x-if="loading">
      <div
        class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-[#f15a24]/90 text-white text-[11px] px-2 py-1 rounded-md shadow-md animate-fade-in tracking-wide z-50">
        ‚ú® Razonando..
      </div>
    </template>
    <svg class="relative w-6 h-6 text-[#f15a24] group-hover:rotate-3 transition-transform"
      xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 2v2m0 0a6 6 0 00-6 6v2H5a2 2 0 00-2 2v2a2 2 0 002 2h1v1a3 3 0 003 3h6a3 3 0 003-3v-1h1a2 2 0 002-2v-2a2 2 0 00-2-2h-1V10a6 6 0 00-6-6z" />
    </svg>
  </button>

  <!-- Panel -->
  <div x-show="open"
    class="fixed bottom-24 right-5 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl flex flex-col border border-gray-200 overflow-hidden"
    :style="`width: ${width}px; height: ${height}px; min-width: 300px; min-height: 300px; max-height: 90vh; max-width: 90vw;`">

    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-br from-[#f15a24] to-[#f77a3c] text-white">
      <span class="font-semibold">Asistente IA</span>
      <div class="flex items-center gap-2">
        <button @click="messages = []" title="Limpiar chat"
          class="text-sm bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition">
          üßπ
        </button>
        <button @click="open = false" class="hover:text-gray-200">‚úñ</button>
      </div>
    </div>

    <!-- Controles -->
    <div class="flex justify-between items-center px-3 pt-2 text-sm gap-2">
      <div class="flex flex-wrap gap-2 text-xs text-gray-700">
        <span class="font-semibold text-gray-500">Tama√±o:</span>
        <div class="flex items-center gap-1">
          <button @click="width -= 40" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-100">‚àí
            ancho</button>
          <button @click="width += 40" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-100">+
            ancho</button>
        </div>
        <div class="flex items-center gap-1 ml-2">
          <button @click="height -= 40" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-100">‚àí
            alto</button>
          <button @click="height += 40" class="px-2 py-1 border border-gray-300 rounded hover:bg-gray-100">+
            alto</button>
        </div>
      </div>
      <button @click="resetChat" class="text-xs px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 transition">
        üßπ Limpiar chat
      </button>

    </div>

    <!-- Mensajes -->
    <div class="flex-1 p-4 overflow-y-auto space-y-3 text-sm" id="chat-messages">
      <template x-for="msg in messages" :key="msg.id">
        <div :class="msg.role === 'user' ? 'text-right' : 'text-left'">
          <span class="inline-block max-w-[80%] px-4 py-2 rounded-xl shadow-sm"
            :class="msg.role === 'user' ? 'bg-gray-100' : 'bg-[#fff6f2] text-[#f15a24] border border-[#f15a24]/30'"
            x-text="msg.content"></span>
        </div>
      </template>
      <template x-if="loading">
        <div class="text-left text-[#f15a24] animate-pulse">
          <span class="inline-block bg-[#fff6f2] px-4 py-2 rounded-xl border border-[#f15a24]/30">Escribiendo...</span>
        </div>
      </template>
    </div>

    <!-- Input -->
    <div class="p-3 border-t flex items-center gap-2 bg-gray-50">
      <input x-ref="input" x-model="input" @keydown.enter="sendMessage" placeholder="Escribe tu mensaje..."
        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-sm focus:ring-2 focus:ring-[#f15a24]/50 focus:outline-none" />
      <button @click="sendMessage" class="px-4 py-2 rounded-lg bg-[#f15a24] text-white hover:bg-[#e75218] transition">
        ‚û§
      </button>
    </div>
  </div>
</div>

<style>
  @keyframes fade-in {
    0% {
      opacity: 0;
      transform: translateY(4px);
    }

    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.4s ease-in-out;
  }
</style>

<script>
  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function chatWidget() {
    return {
      open: false,
      input: '',
      messages: [],
      loading: false,
      width: 384,
      height: 500,
      sessionId: null,

      init() {
        // ID persistente por usuario
        let sid = localStorage.getItem('sessionId');
        if (!sid) {
          sid = generateUUID();
          localStorage.setItem('sessionId', sid);
        }
        this.sessionId = sid;

        // Persistencia de tama√±o
        const w = localStorage.getItem('chatWidth');
        const h = localStorage.getItem('chatHeight');
        if (w) this.width = parseInt(w);
        if (h) this.height = parseInt(h);

        this.$watch('width', val => localStorage.setItem('chatWidth', val));
        this.$watch('height', val => localStorage.setItem('chatHeight', val));
        window.chat = this;
      },

      async sendMessage() {
        const text = this.input.trim();
        if (!text) return;

        this.messages.push({ id: Date.now(), role: 'user', content: text });
        this.input = '';
        const assistantId = Date.now() + 1;
        this.messages.push({ id: assistantId, role: 'assistant', content: '' });
        this.loading = true;

        try {
          await sendToLLMStreamed(text, this.sessionId, chunk => {
            const msg = this.messages.find(m => m.id === assistantId);
            msg.content += chunk;
            this.$nextTick(() => this.scrollToBottom());
          });
        } catch {
          this.messages.push({ id: Date.now() + 2, role: 'assistant', content: '‚ùå Error al contactar con el modelo.' });
        } finally {
          this.loading = false;
        }
      },
      async resetChat() {
        this.messages = [];

        try {
          await fetch("http://192.168.2.202:8001/reset", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: this.sessionId }),
          });
        } catch {
          console.warn("‚ùå No se pudo resetear la memoria del backend.");
        }
      },


      scrollToBottom() {
        const el = document.getElementById('chat-messages');
        if (el) el.scrollTop = el.scrollHeight;
      }
    };
  }

  async function sendToLLMStreamed(message, sessionId, onChunk) {
    const response = await fetch("http://192.168.2.202:8001/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input: message, session_id: sessionId })
    });

    if (!response.ok) throw new Error("‚ùå Error al conectar con el backend.");
    const text = await response.text();

    try {
      const data = JSON.parse(text);
      onChunk(data.output || text);
    } catch {
      onChunk(text);
    }
  }


</script>